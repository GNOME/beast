# Beast Tests
#
## GNU Lesser General Public License version 2 or any later version.

FEATURE_TEST_SH=$(srcdir)/featuretest.sh

noinst_build_sources += beastconf.sh
beastconf.sh: Makefile
	cd . \
	&& echo "# Generated data from $< (by make $@)" > xgen-bp \
	&& echo >> xgen-bp \
	&& echo "BIN_VERSION=$(BIN_VERSION)" >> xgen-bp \
	&& echo "top_builddir=$(top_builddir)" >> xgen-bp \
	&& echo "srcdir=$(srcdir)" >> xgen-bp \
	&& chmod 755 xgen-bp \
	&& (cp xgen-bp $@) \
	&& rm -f xgen-bp
CLEANFILES += beastconf.sh xgen-bp

test: beastconf.sh reset-summary
	@for ftest in $(FEATURE_TESTS) ; do \
		$(MAKE) -C . $(AM_MAKEFLAGS) $$ftest ; \
	done
	@$(FEATURE_TEST_SH) --summary
	@$(FEATURE_TEST_SH) --reset-summary
# in case featuretest.sh --summary fails
CLEANFILES += featuretest-summary.sh

reset-summary: beastconf.sh
	$(FEATURE_TEST_SH) --reset-summary

# files generated by feature tests
CLEANFILES += *.current *.bse.wav

FEATURE_TESTS = test-bseadder test-balance-left test-balance-right
test-bseadder: beastconf.sh
	@$(FEATURE_TEST_SH) bseadder.bse bseadder.reference \
	               --avg-spectrum --avg-energy \
	            -- --threshold=99.99

test-balance-left: beastconf.sh
	@$(FEATURE_TEST_SH) balance.bse balance-left.reference \
	               --channel=0 --avg-spectrum --avg-energy --spectrum \
	            -- --threshold=99.99
test-balance-right: beastconf.sh
	@$(FEATURE_TEST_SH) balance.bse balance-right.reference \
	               --channel=1 --avg-spectrum --avg-energy --spectrum \
	            -- --threshold=99.99

EXTRA_DIST += $(strip		\
	balance-left.reference	\
	balance-right.reference	\
	bsetowav.scm		\
	balance.bse		\
	bseadder.bse		\
	bseadder.reference	\
	featuretest.sh		\
)
